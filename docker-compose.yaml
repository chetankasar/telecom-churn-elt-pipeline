# ============================================
# Telecom Churn Insights - Docker Compose
# ============================================

x-airflow-common: &airflow-common
  build:
    context: ./docker/airflow
    dockerfile: Dockerfile
  environment: &airflow-common-env
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
    AIRFLOW__CORE__FERNET_KEY: ''
    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: 'true'
    AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
    AIRFLOW__API__AUTH_BACKENDS: 'airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session'
    AIRFLOW__SCHEDULER__ENABLE_HEALTH_CHECK: 'true'
    AIRFLOW__CORE__DEFAULT_TIMEZONE: 'UTC'
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  volumes:
    - ./airflow/dags:/opt/airflow/dags
    - ./airflow/logs:/opt/airflow/logs
    - ./airflow/plugins:/opt/airflow/plugins
    - ./airflow/config:/opt/airflow/config
    - ./data:/opt/airflow/data
  depends_on: &airflow-common-depends-on
    postgres:
      condition: service_healthy

services:
  # ============================================
  # PostgreSQL Database
  # Databases: airflow, staging, telecom, superset
  # ============================================
  postgres:
    build:
      context: ./docker/postgres
      dockerfile: Dockerfile
    container_name: telecom_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - telecom_network

  # ============================================
  # Apache Airflow - Webserver
  # ============================================
  airflow-webserver:
    <<: *airflow-common
    container_name: telecom_airflow_webserver
    command: webserver
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      <<: *airflow-common-depends-on
      airflow-init:
        condition: service_completed_successfully
    networks:
      - telecom_network

  # ============================================
  # Apache Airflow - Scheduler
  # ============================================
  airflow-scheduler:
    <<: *airflow-common
    container_name: telecom_airflow_scheduler
    command: scheduler
    healthcheck:
      test: ["CMD", "airflow", "jobs", "check", "--job-type", "SchedulerJob", "--hostname", "$${HOSTNAME}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      <<: *airflow-common-depends-on
      airflow-init:
        condition: service_completed_successfully
    networks:
      - telecom_network

  # ============================================
  # Apache Airflow - Init (one-time setup)
  # ============================================
  airflow-init:
    <<: *airflow-common
    container_name: telecom_airflow_init
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        airflow users create \
          --username airflow \
          --password airflow \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com || true
        airflow version
    environment:
      <<: *airflow-common-env
    networks:
      - telecom_network

  # ============================================
  # Apache Superset
  # ============================================
  superset:
    build:
      context: ./docker/superset
      dockerfile: Dockerfile
    container_name: telecom_superset
    environment:
      SUPERSET_SECRET_KEY: 'telecom_superset_secret_key_change_in_production'
      SUPERSET_LOAD_EXAMPLES: 'no'
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_DB: superset
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
    ports:
      - "8088:8088"
    volumes:
      - superset_data:/app/superset_home
      - ./superset/superset_config.py:/app/pythonpath/superset_config.py
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - telecom_network
    command: >
      bash -c "
        superset db upgrade &&
        superset fab create-admin --username admin --firstname Admin --lastname User --email admin@telecom.com --password admin || true &&
        superset init &&
        superset run -h 0.0.0.0 -p 8088 --with-threads --reload
      "

volumes:
  postgres_data:
  superset_data:

networks:
  telecom_network:
    driver: bridge
